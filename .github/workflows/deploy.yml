name: Deploy to Windows Server

on:
  push:
    branches: ["main"]

jobs:
  deploy:
    runs-on: self-hosted

    defaults:
      run:
        shell: powershell

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"

      - name: Retrieve .env from Live Site
        run: |
          $PROD_ENV = "C:\Server\htdocs\cajasmart\.env"
          if (Test-Path $PROD_ENV) {
            Copy-Item -Path $PROD_ENV -Destination ".\.env" -Force
          }

      - name: Clean install state
        run: |
          if (Test-Path node_modules) { Remove-Item -Recurse -Force node_modules }
          if (Test-Path package-lock.json) { Remove-Item -Force package-lock.json }

      - name: Install dependencies (no scripts)
        run: npm install --ignore-scripts

      - name: Prepare Nuxt
        run: npx nuxi prepare

      - name: Build
        run: npm run build

      - name: Deploy to Production Folder
        run: |
          $TARGET = "C:\Server\htdocs\cajasmart"

          if (!(Test-Path $TARGET)) {
            New-Item -ItemType Directory -Force -Path $TARGET | Out-Null
          }

          try { pm2 stop cajasmart } catch {}

          Copy-Item -Path ".\*" -Destination $TARGET -Recurse -Force -Exclude ".git","node_modules"

          Set-Location $TARGET

          if (Test-Path node_modules) { Remove-Item -Recurse -Force node_modules }
          npm install --omit=dev --ignore-scripts

          try {
            pm2 restart cajasmart --update-env
          } catch {
            pm2 start process.yml
          }
