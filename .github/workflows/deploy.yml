name: Deploy to Windows Server

on:
  push:
    branches: ["main"]

jobs:
  deploy:
    runs-on: self-hosted

    defaults:
      run:
        shell: cmd

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: "18"

      - name: Retrieve .env from Live Site
        run: |
          if exist C:\Server\htdocs\cajasmart\.env (
            copy /Y C:\Server\htdocs\cajasmart\.env .env
          )

      - name: Clean install state
        run: |
          if exist node_modules rmdir /s /q node_modules
          if exist package-lock.json del package-lock.json

      - name: Install dependencies (no scripts)
        run: npm install --ignore-scripts

      - name: Prepare Nuxt
        run: npx nuxi prepare

      - name: Build
        run: npm run build

      - name: Deploy
        run: |
          set TARGET=C:\Server\htdocs\cajasmart

          if not exist %TARGET% mkdir %TARGET%

          pm2 stop cajasmart || echo not running

          xcopy . %TARGET% /E /I /Y /EXCLUDE:.git,node_modules

          cd /d %TARGET%

          if exist node_modules rmdir /s /q node_modules
          npm install --omit=dev --ignore-scripts

          pm2 restart cajasmart || pm2 start process.yml
