name: Deploy to Windows Server

on:
  push:
    branches: ["main"]

jobs:
  deploy:
    runs-on: self-hosted

    steps:
      # 1. Get latest code
      - name: Checkout code
        uses: actions/checkout@v4

      # 2. Setup Node
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"

      # 3. COPY EXISTING .ENV FROM SERVER
      - name: Retrieve .env from Live Site
        shell: pwsh
        run: |
          $PROD_ENV = "C:\Server\htdocs\cajasmart\.env"

          if (Test-Path $PROD_ENV) {
            Write-Host "Copying .env from production folder..."
            Copy-Item -Path $PROD_ENV -Destination ".\.env" -Force
          } else {
            Write-Warning "CRITICAL: .env file not found at $PROD_ENV. Ensure it exists on the server!"
          }

      # 4. Clean deps to avoid optional-deps native binding misses on Windows
      - name: Clean install artifacts
        shell: pwsh
        run: |
          if (Test-Path ".\node_modules") { Remove-Item -Recurse -Force ".\node_modules" }
          if (Test-Path ".\package-lock.json") { Remove-Item -Force ".\package-lock.json" }
          npm cache verify | Out-Null

      # 5. Install Dependencies (For Build) - force optional deps
      - name: Install Dependencies
        shell: pwsh
        run: |
          npm install --include=optional

      # 6. Build Nuxt
      - name: Build Application
        shell: pwsh
        run: |
          npm run build

      # 7. Deploy to Production (Stop -> Copy -> Install -> Start)
      - name: Deploy to Production Folder
        shell: pwsh
        run: |
          $TARGET = "C:\Server\htdocs\cajasmart"

          # Create target if not exists
          if (!(Test-Path -Path $TARGET)) { New-Item -ItemType Directory -Force -Path $TARGET | Out-Null }

          # STOP THE APP (Releases file locks on .nuxt folder)
          Write-Host "Stopping App to release file locks..."
          try { pm2 stop cajasmart } catch { Write-Host "App was not running, skipping stop." }

          # Copy everything from Runner to Target
          # Exclude node_modules (reinstall in target)
          Write-Host "Deploying files to $TARGET..."
          Copy-Item -Path ".\*" -Destination $TARGET -Recurse -Force -Exclude ".git","node_modules"

          # Go to target
          Set-Location $TARGET

          # Install prod dependencies (still include optional for native bindings)
          Write-Host "Installing production dependencies..."
          if (Test-Path ".\node_modules") { Remove-Item -Recurse -Force ".\node_modules" }
          if (Test-Path ".\package-lock.json") { Remove-Item -Force ".\package-lock.json" }
          npm install --omit=dev --include=optional

          # Start/Restart PM2
          Write-Host "Starting App..."
          try {
            pm2 restart cajasmart --update-env
          } catch {
            pm2 start process.yml
          }
