name: Deploy to Windows Server

on:
  push:
    branches: ["main"]

jobs:
  deploy:
    runs-on: self-hosted

    defaults:
      run:
        shell: cmd

    env:
      TARGET: C:\Server\htdocs\cajasmart
      PROD_ENV: C:\Server\htdocs\cajasmart\.env

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"

      - name: Copy .env from production for build (do not overwrite on deploy)
        run: |
          if exist "%PROD_ENV%" (
            copy /Y "%PROD_ENV%" ".env"
          ) else (
            echo WARNING: .env not found at "%PROD_ENV%"
          )

      - name: Clean workspace deps
        run: |
          if exist node_modules rmdir /s /q node_modules

      - name: Install deps (deterministic, no scripts)
        run: |
          npm ci --ignore-scripts

      - name: Prepare Nuxt
        run: |
          npx nuxi prepare

      - name: Build
        run: |
          npm run build

      - name: Ensure target exists
        run: |
          if not exist "%TARGET%" mkdir "%TARGET%"

      - name: Stop app
        run: |
          pm2 stop cajasmart || echo not running

      - name: Deploy files (robocopy, excludes node_modules/.git/.github and .env)
        run: |
          robocopy "." "%TARGET%" /E /XD node_modules .git .github /XF .env
          set RC=%ERRORLEVEL%
          if %RC% LSS 8 (exit /b 0) else (exit /b %RC%)

      - name: Install production deps on target (no scripts)
        run: |
          cd /d "%TARGET%"
          if exist node_modules rmdir /s /q node_modules
          npm ci --omit=dev --ignore-scripts

      - name: Start app
        run: |
          cd /d "%TARGET%"
          pm2 restart cajasmart --update-env || pm2 start process.yml
