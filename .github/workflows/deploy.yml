name: Deploy to Windows Server

on:
  push:
    branches: ["main"]

jobs:
  deploy:
    runs-on: self-hosted

    defaults:
      run:
        shell: powershell

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # Build toolchain needs Node 20+ (does NOT change your server install)
      - name: Setup Node.js (CI only)
        uses: actions/setup-node@v4
        with:
          node-version: "20.19.0"

      - name: Retrieve .env from Live Site
        run: |
          $ErrorActionPreference = "Stop"
          $PROD_ENV = "C:\Server\htdocs\cajasmart\.env"
          if (Test-Path $PROD_ENV) {
            Copy-Item $PROD_ENV (Join-Path $env:GITHUB_WORKSPACE ".env") -Force
          } else {
            Write-Warning "No .env found at $PROD_ENV"
          }

      - name: Install Dependencies
        run: |
          $ErrorActionPreference = "Stop"
          Set-Location $env:GITHUB_WORKSPACE
          if (Test-Path node_modules) { Remove-Item node_modules -Recurse -Force }
          npm install

      - name: Prepare + Build
        run: |
          $ErrorActionPreference = "Stop"
          Set-Location $env:GITHUB_WORKSPACE
          npx nuxi prepare
          npm run build

      - name: Deploy to Production Folder
        run: |
          $ErrorActionPreference = "Stop"
          $TARGET = "C:\Server\htdocs\cajasmart"

          if (!(Test-Path $TARGET)) {
            New-Item -ItemType Directory -Force -Path $TARGET | Out-Null
          }

          # Stop if running (don't fail the job if not)
          pm2 delete cajasmart -s 2>$null

          # Clean target except .env
          Get-ChildItem $TARGET -Force |
            Where-Object { $_.Name -ne ".env" } |
            Remove-Item -Recurse -Force

          # Copy build output
          Copy-Item (Join-Path $env:GITHUB_WORKSPACE ".output\*") $TARGET -Recurse -Force

          # Ensure PM2 config is present in target
          Copy-Item (Join-Path $env:GITHUB_WORKSPACE "process.yml") $TARGET -Force

          # Install runtime deps in the deployed folder (Nitro node-server needs these)
          Set-Location $TARGET
          if (Test-Path node_modules) { Remove-Item node_modules -Recurse -Force }
          npm install --omit=dev --ignore-scripts

          # Start app
          pm2 start process.yml
          pm2 save
